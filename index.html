<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Devickaya ‚Äî –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∫–∞–ª–æ—Ä–∏–π & –¥–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg: #020617;
      --bg-soft: #0f172a;
      --accent: #22c55e;
      --accent-blue: #0ea5e9;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border: #334155;
    }

    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: #020617;
      color: var(--text-main);
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .app {
      width: 100%;
      max-width: 520px;
      padding: 14px;
    }

    .card {
      background: #0f172a;
      border-radius: 22px;
      border: 1px solid var(--border);
      padding: 14px;
      box-shadow: 0 15px 50px rgba(0, 0, 0, 0.8);
    }

    /* Header */
    .header {
      display: flex;
      gap: 12px;
      margin-bottom: 14px;
    }

    .brand-logo-wrapper {
      flex-shrink: 0;
      width: 80px;
      height: 80px;
      border-radius: 20px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .brand-logo-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .header-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
      justify-content: center;
    }

    .logo-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #020617;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 11px;
      color: var(--text-muted);
      width: fit-content;
    }

    .logo-dot {
      width: 7px;
      height: 7px;
      background: var(--accent);
      border-radius: 999px;
    }

    h1 {
      font-size: 18px;
      margin: 0;
    }

    .header-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .chip-beta {
      align-self: flex-start;
      margin-left: auto;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    /* Tabs */
    .tabs {
      margin-top: 4px;
      display: flex;
      background: #020617;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 3px;
      gap: 3px;
    }

    .tab-btn {
      flex: 1;
      background: transparent;
      border: none;
      border-radius: 999px;
      padding: 8px;
      font-size: 13px;
      color: var(--text-muted);
      cursor: pointer;
    }

    .tab-btn.active {
      background: linear-gradient(120deg, rgba(34, 197, 94, 0.4), rgba(14, 165, 233, 0.4));
      color: var(--text-main);
      font-weight: 600;
    }

    .tab {
      display: none;
      margin-top: 16px;
    }

    .tab.active {
      display: block;
    }

    /* Inputs */
    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 10px;
    }

    label {
      font-size: 12px;
      color: var(--text-muted);
    }

    input, select {
      width: 100%;
      padding: 8px;
      border-radius: 12px;
      background: #020617;
      border: 1px solid var(--border);
      color: var(--text-main);
      font-size: 14px;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .btn {
      width: 100%;
      padding: 10px;
      border-radius: 999px;
      background: linear-gradient(120deg, #22c55e, #4ade80);
      border: none;
      font-size: 14px;
      font-weight: 600;
      color: #022c22;
      margin-top: 14px;
      cursor: pointer;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid var(--border);
      color: var(--text-muted);
      cursor: pointer;
    }

    .btn-danger {
      border-color: #ef4444;
      color: #fecaca;
    }

    /* Card Previews & Macros */
    .result-card,
    .card-preview {
      background: #0f172a;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid var(--border);
      margin-top: 14px;
      font-size: 13px;
    }

    .result-row,
    .macros-row {
      display: flex;
      justify-content: space-between;
      margin-top: 6px;
    }

    .macros-pill {
      padding: 4px 8px;
      background: #020617;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 11px;
    }

    /* Autocomplete */
    .autocomplete-wrapper {
      position: relative;
    }

    .autocomplete-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #0f172a;
      border-radius: 12px;
      border: 1px solid var(--border);
      margin-top: 4px;
      z-index: 1000;
      max-height: 230px;
      overflow-y: auto;
    }

    .autocomplete-item {
      padding: 8px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      font-size: 12px;
    }

    .autocomplete-item:hover {
      background: #1e293b;
    }

    .hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }
  </style>
</head>

<body>
<div class="app">
  <div class="card">

    <!-- HEADER -->
    <div class="header">
      <div class="brand-logo-wrapper">
        <!-- –ø–æ–ª–æ–∂–∏ brand-logo-devickaya.png –≤ –∫–æ—Ä–µ–Ω—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è -->
        <img src="brand-logo-devickaya.png" alt="Devickaya" />
      </div>

      <div class="header-main">
        <div class="logo-pill">
          <div class="logo-dot"></div>
          Devickaya ‚Ä¢ MiniApp
        </div>

        <h1>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∫–∞–ª–æ—Ä–∏–π & –¥–Ω–µ–≤–Ω–∏–∫</h1>
        <div class="header-subtitle">
          –ü–æ–¥–±–µ—Ä–∏—Ç–µ –Ω–æ—Ä–º—É, —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –±–ª—é–¥–∞ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –ø–∏—Ç–∞–Ω–∏–µ
        </div>
      </div>

      <div class="chip-beta">beta</div>
    </div>

    <!-- TABS -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="calc">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</button>
      <button class="tab-btn" data-tab="cards">–ö–∞—Ä—Ç–æ—á–∫–∏ –±–ª—é–¥</button>
      <button class="tab-btn" data-tab="diary">–î–Ω–µ–≤–Ω–∏–∫</button>
    </div>

    <!-- TAB 1: –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–† -->
    <div id="tab-calc" class="tab active">

      <div class="field">
        <label>–ü–æ–ª</label>
        <select id="gender">
          <option value="female">–ñ–µ–Ω—â–∏–Ω–∞</option>
          <option value="male">–ú—É–∂—á–∏–Ω–∞</option>
        </select>
      </div>

      <div class="field">
        <label>–í–æ–∑—Ä–∞—Å—Ç</label>
        <input id="age" type="number" placeholder="30" />
      </div>

      <div class="field">
        <label>–†–æ—Å—Ç (—Å–º)</label>
        <input id="height" type="number" placeholder="170" />
      </div>

      <div class="field">
        <label>–í–µ—Å (–∫–≥)</label>
        <input id="weight" type="number" placeholder="60" />
      </div>

      <div class="field">
        <label>–£—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</label>
        <select id="activity">
          <option value="1.2">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è</option>
          <option value="1.375">–õ—ë–≥–∫–∞—è</option>
          <option value="1.55">–°—Ä–µ–¥–Ω—è—è</option>
          <option value="1.725">–í—ã—Å–æ–∫–∞—è</option>
        </select>
      </div>

      <button class="btn" id="btnCalc">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>

      <div id="calcResult"></div>
    </div>

    <!-- TAB 2: –ö–ê–†–¢–û–ß–ö–ò –ë–õ–Æ–î -->
    <div id="tab-cards" class="tab">

      <div class="field autocomplete-wrapper">
        <label>–í—ã–±—Ä–∞—Ç—å –±–ª—é–¥–æ –∏–∑ –±–∞–∑—ã</label>
        <input id="dbSearch" type="text" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å..." autocomplete="off" />
        <div id="autocompleteList" class="autocomplete-list" style="display:none;"></div>
        <div class="hint">
          –ï—Å–ª–∏ –±–ª—é–¥–æ –µ—Å—Ç—å –≤ –±–∞–∑–µ ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –µ–≥–æ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ.
          –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ—ë –±–ª—é–¥–æ –Ω–∏–∂–µ.
        </div>
      </div>

      <div class="field">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞</label>
        <input id="dishName" type="text" />
      </div>

      <div class="field">
        <label>–ë–µ–ª–∫–∏ / 100 –≥</label>
        <input id="protein100" type="number" step="0.1" />
      </div>

      <div class="field">
        <label>–ñ–∏—Ä—ã / 100 –≥</label>
        <input id="fat100" type="number" step="0.1" />
      </div>

      <div class="field">
        <label>–£–≥–ª–µ–≤–æ–¥—ã / 100 –≥</label>
        <input id="carbs100" type="number" step="0.1" />
      </div>

      <div class="field">
        <label>–ö–∞–ª–æ—Ä–∏–∏ / 100 –≥</label>
        <input id="kcal100" type="number" step="1" />
      </div>

      <div class="field">
        <label>–ú–∞—Å—Å–∞ –ø–æ—Ä—Ü–∏–∏ (–≥)</label>
        <input id="portion" type="number" />
      </div>

      <button class="btn" id="btnSaveDish">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–ª—é–¥–æ</button>

      <div id="cardsList" style="margin-top:16px;"></div>
    </div>

    <!-- TAB 3: –î–ù–ï–í–ù–ò–ö -->
    <div id="tab-diary" class="tab">
      <div class="field">
        <label>–î–∞—Ç–∞</label>
        <input id="mealDate" type="date" />
      </div>

      <div class="field">
        <label>–í—Ä–µ–º—è</label>
        <input id="mealTime" type="time" />
      </div>

      <div class="field">
        <label>–¢–∏–ø –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏</label>
        <select id="mealType">
          <option value="breakfast">–ó–∞–≤—Ç—Ä–∞–∫</option>
          <option value="lunch">–û–±–µ–¥</option>
          <option value="dinner">–£–∂–∏–Ω</option>
          <option value="snack">–ü–µ—Ä–µ–∫—É—Å</option>
        </select>
      </div>

      <div class="field">
        <label>–ë–ª—é–¥–æ –∏–∑ –∫–∞—Ä—Ç–æ—á–µ–∫</label>
        <select id="mealDishSelect"></select>
      </div>

      <div class="field">
        <label>–ò–ª–∏ —Å–≤–æ—ë –±–ª—é–¥–æ</label>
        <input id="mealCustomName" type="text" />
      </div>

      <div class="field">
        <label>–ü–æ—Ä—Ü–∏—è (–≥)</label>
        <input id="mealPortion" type="number" />
      </div>

      <button class="btn" id="btnAddMeal">–î–æ–±–∞–≤–∏—Ç—å –≤ –¥–Ω–µ–≤–Ω–∏–∫</button>

      <div id="diaryList" style="margin-top:18px;"></div>
    </div>
  </div>
</div>

<!-- –ë–ê–ó–ê –ë–õ–Æ–î: –≤ —ç—Ç–æ–º —Ñ–∞–π–ª–µ –æ–±—ä—è–≤–ª–µ–Ω window.DISH_DB -->
<script src="dish_db_from_excel.js"></script>

<script>
  // ============================
  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
  // ============================
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabs = document.querySelectorAll('.tab');

  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const targetId = 'tab-' + btn.dataset.tab;
      tabButtons.forEach(b => b.classList.remove('active'));
      tabs.forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      const target = document.getElementById(targetId);
      if (target) target.classList.add('active');
    });
  });

  // ============================
  // –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∫–∞–ª–æ—Ä–∏–π
  // ============================
  const btnCalc = document.getElementById('btnCalc');

  btnCalc.addEventListener('click', () => {
    const gender = document.getElementById('gender').value;
    const age = parseFloat(document.getElementById('age').value || '0');
    const height = parseFloat(document.getElementById('height').value || '0');
    const weight = parseFloat(document.getElementById('weight').value || '0');
    const activity = parseFloat(document.getElementById('activity').value || '1.2');

    if (!age || !height || !weight) {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç, —Ä–æ—Å—Ç –∏ –≤–µ—Å');
      return;
    }

    let bmr;
    if (gender === 'male') {
      bmr = 10 * weight + 6.25 * height - 5 * age + 5;
    } else {
      bmr = 10 * weight + 6.25 * height - 5 * age - 161;
    }

    const maintain = bmr * activity;

    const resultEl = document.getElementById('calcResult');
    resultEl.innerHTML = `
      <div class="result-card">
        <div class="result-row">
          <div>–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ:</div>
          <div><strong>${Math.round(maintain)} –∫–∫–∞–ª</strong></div>
        </div>
      </div>
    `;
  });

  // ============================
  // –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã DISH_DB
  // ============================
  let DISH_DB = [];

  (function initDishDb() {
    const raw = window.DISH_DB;
    if (Array.isArray(raw)) {
      DISH_DB = raw;
      return;
    }
    if (raw && typeof raw === 'object') {
      DISH_DB = Object.keys(raw).map(key => {
        const x = raw[key] || {};
        return {
          name: x.name || x.title || key,
          protein: x.protein ?? x.protein100 ?? x.b ?? 0,
          fat: x.fat ?? x.fats100 ?? x.j ?? 0,
          carbs: x.carbs ?? x.carbs100 ?? x.u ?? 0,
          kcal: x.kcal ?? x.kcal100 ?? x.calories ?? x.kal ?? 0
        };
      });
    }
  })();

  // ============================
  // –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
  // ============================
  const dbSearchEl = document.getElementById('dbSearch');
  const autocompleteListEl = document.getElementById('autocompleteList');

  function filterDishDb(query) {
    if (!query) return [];
    const q = query.toLowerCase();
    const items = DISH_DB.filter(item => {
      const name = String(item.name || '').toLowerCase();
      return name.includes(q);
    });
    return items.slice(0, 50);
  }

  function renderAutocomplete(items) {
    autocompleteListEl.innerHTML = '';
    if (!items.length) {
      const empty = document.createElement('div');
      empty.className = 'autocomplete-item';
      empty.textContent = '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
      autocompleteListEl.appendChild(empty);
      autocompleteListEl.style.display = 'block';
      return;
    }

    items.forEach(item => {
      const row = document.createElement('div');
      row.className = 'autocomplete-item';

      const nameDiv = document.createElement('div');
      nameDiv.textContent = item.name || '';

      const kcalDiv = document.createElement('div');
      kcalDiv.style.fontSize = '11px';
      kcalDiv.style.color = '#9ca3af';
      const kcal = item.kcal || 0;
      kcalDiv.textContent = Math.round(kcal) + ' –∫–∫–∞–ª';

      row.appendChild(nameDiv);
      row.appendChild(kcalDiv);

      row.addEventListener('click', () => {
        applyDishFromDb(item);
        autocompleteListEl.style.display = 'none';
      });

      autocompleteListEl.appendChild(row);
    });

    autocompleteListEl.style.display = 'block';
  }

  function applyDishFromDb(item) {
    const name = item.name || '';
    const p = parseFloat(item.protein || 0);
    const f = parseFloat(item.fat || 0);
    const c = parseFloat(item.carbs || 0);
    const k = parseFloat(item.kcal || 0);

    dbSearchEl.value = name;
    document.getElementById('dishName').value = name;
    document.getElementById('protein100').value = p || '';
    document.getElementById('fat100').value = f || '';
    document.getElementById('carbs100').value = c || '';
    document.getElementById('kcal100').value = k || '';
  }

  dbSearchEl.addEventListener('input', () => {
    const query = dbSearchEl.value.trim();
    if (!query) {
      autocompleteListEl.style.display = 'none';
      return;
    }
    const items = filterDishDb(query);
    renderAutocomplete(items);
  });

  document.addEventListener('click', (e) => {
    if (!autocompleteListEl.contains(e.target) && e.target !== dbSearchEl) {
      autocompleteListEl.style.display = 'none';
    }
  });

  // ============================
  // –ö–∞—Ä—Ç–æ—á–∫–∏ –±–ª—é–¥ (localStorage)
  // ============================
  const STORAGE_CARDS_KEY = 'devickaya_cards_v1';
  const cardsListEl = document.getElementById('cardsList');
  const btnSaveDish = document.getElementById('btnSaveDish');

  function loadCards() {
    try {
      const raw = localStorage.getItem(STORAGE_CARDS_KEY);
      if (!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    } catch (e) {
      console.log('cards parse error', e);
      return [];
    }
  }

  function saveCards(list) {
    localStorage.setItem(STORAGE_CARDS_KEY, JSON.stringify(list));
    updateDishSelect();
  }

  function renderCards() {
    const list = loadCards();
    cardsListEl.innerHTML = '';

    if (!list.length) {
      const empty = document.createElement('div');
      empty.className = 'hint';
      empty.textContent = '–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –±–ª—é–¥. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–µ—Ä–≤–æ–µ –±–ª—é–¥–æ –≤—ã—à–µ.';
      cardsListEl.appendChild(empty);
      return;
    }

    list.forEach(card => {
      const wrap = document.createElement('div');
      wrap.className = 'card-preview';

      const nameDiv = document.createElement('div');
      nameDiv.innerHTML = '<strong>' + card.name + '</strong>';

      const line100 = document.createElement('div');
      line100.textContent = `100 –≥: –ë ${card.p} ‚Ä¢ –ñ ${card.f} ‚Ä¢ –£ ${card.c} ‚Ä¢ ${card.k} –∫–∫–∞–ª`;

      wrap.appendChild(nameDiv);
      wrap.appendChild(line100);

      if (card.w) {
        const wLine = document.createElement('div');
        const kcalPortion = Math.round(card.k * card.w / 100);
        wLine.textContent = `${card.w} –≥: ${kcalPortion} –∫–∫–∞–ª`;
        wrap.appendChild(wLine);
      }

      const actions = document.createElement('div');
      actions.style.marginTop = '8px';
      actions.style.display = 'flex';
      actions.style.gap = '8px';

      const btnCopy = document.createElement('button');
      btnCopy.className = 'btn-small';
      btnCopy.textContent = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
      btnCopy.addEventListener('click', () => {
        const base = `üçΩ ${card.name}
100 –≥: –ë ${card.p} –≥, –ñ ${card.f} –≥, –£ ${card.c} –≥, ${card.k} –∫–∫–∞–ª`;
        const portionStr = card.w
          ? `\n${card.w} –≥: ${Math.round(card.k * card.w / 100)} –∫–∫–∞–ª`
          : '';
        navigator.clipboard.writeText(base + portionStr)
          .then(() => alert('–ö–∞—Ä—Ç–æ—á–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ ‚úÖ'))
          .catch(() => alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ‚ùå'));
      });

      const btnDel = document.createElement('button');
      btnDel.className = 'btn-small btn-danger';
      btnDel.textContent = '–£–¥–∞–ª–∏—Ç—å';
      btnDel.addEventListener('click', () => {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –±–ª—é–¥–∞?')) return;
        const updated = loadCards().filter(x => x.id !== card.id);
        saveCards(updated);
        renderCards();
      });

      actions.appendChild(btnCopy);
      actions.appendChild(btnDel);
      wrap.appendChild(actions);

      cardsListEl.appendChild(wrap);
    });
  }

  btnSaveDish.addEventListener('click', () => {
    const name = document.getElementById('dishName').value.trim();
    const p = parseFloat(document.getElementById('protein100').value || '0');
    const f = parseFloat(document.getElementById('fat100').value || '0');
    const c = parseFloat(document.getElementById('carbs100').value || '0');
    const k = parseFloat(document.getElementById('kcal100').value || '0');
    const w = parseFloat(document.getElementById('portion').value || '0');

    if (!name) {
      alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞');
      return;
    }

    const cards = loadCards();
    cards.unshift({
      id: Date.now().toString(),
      name,
      p,
      f,
      c,
      k,
      w: w || null
    });
    saveCards(cards);
    renderCards();
  });

  // ============================
  // –î–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è
  // ============================
  const STORAGE_DIARY_KEY = 'devickaya_diary_v1';
  const diaryListEl = document.getElementById('diaryList');
  const btnAddMeal = document.getElementById('btnAddMeal');

  function loadDiary() {
    try {
      const raw = localStorage.getItem(STORAGE_DIARY_KEY);
      if (!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    } catch (e) {
      console.log('diary parse error', e);
      return [];
    }
  }

  function saveDiary(list) {
    localStorage.setItem(STORAGE_DIARY_KEY, JSON.stringify(list));
  }

  function updateDishSelect() {
    const select = document.getElementById('mealDishSelect');
    const cards = loadCards();
    select.innerHTML = '';
    const empty = document.createElement('option');
    empty.value = '';
    empty.textContent = '‚Äî';
    select.appendChild(empty);
    cards.forEach(card => {
      const opt = document.createElement('option');
      opt.value = card.id;
      opt.textContent = card.name;
      select.appendChild(opt);
    });
  }

  function renderDiary() {
    const diary = loadDiary();
    diaryListEl.innerHTML = '';

    if (!diary.length) {
      const empty = document.createElement('div');
      empty.className = 'hint';
      empty.textContent = '–ó–∞–ø–∏—Å–µ–π –ø–æ–∫–∞ –Ω–µ—Ç.';
      diaryListEl.appendChild(empty);
      return;
    }

    diary.forEach(entry => {
      const wrap = document.createElement('div');
      wrap.className = 'card-preview';

      const title = document.createElement('div');
      title.innerHTML = `<strong>${entry.date} ${entry.time}</strong> ‚Äî ${entry.name}`;

      const line = document.createElement('div');
      line.textContent = `${entry.portion} –≥ ‚Ä¢ ${entry.kcal} –∫–∫–∞–ª`;

      wrap.appendChild(title);
      wrap.appendChild(line);

      diaryListEl.appendChild(wrap);
    });
  }

  btnAddMeal.addEventListener('click', () => {
    const date = document.getElementById('mealDate').value;
    const time = document.getElementById('mealTime').value;
    const type = document.getElementById('mealType').value;
    const dishId = document.getElementById('mealDishSelect').value;
    const customName = document.getElementById('mealCustomName').value.trim();
    const portion = parseFloat(document.getElementById('mealPortion').value || '0');

    if (!date || !time || !portion) {
      alert('–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É, –≤—Ä–µ–º—è –∏ –ø–æ—Ä—Ü–∏—é');
      return;
    }

    let name = customName;
    let p = 0, f = 0, c = 0, k = 0;

    if (dishId) {
      const cards = loadCards();
      const card = cards.find(x => x.id === dishId);
      if (card) {
        name = card.name;
        p = card.p;
        f = card.f;
        c = card.c;
        k = card.k;
      }
    }

    if (!name) {
      alert('–£–∫–∞–∂–∏—Ç–µ –±–ª—é–¥–æ (–≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ—ë)');
      return;
    }

    const kcal = Math.round(k * portion / 100);

    const diary = loadDiary();
    diary.unshift({
      id: Date.now().toString(),
      date,
      time,
      type,
      name,
      portion,
      kcal,
      p, f, c, k
    });
    saveDiary(diary);
    renderDiary();
  });

  // ============================
  // INIT: –¥–∞—Ç–∞/–≤—Ä–µ–º—è + —Ä–µ–Ω–¥–µ—Ä
  // ============================
  (function initDateTime() {
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const dd = String(now.getDate()).padStart(2, '0');
    document.getElementById('mealDate').value = `${yyyy}-${mm}-${dd}`;
    const hh = String(now.getHours()).padStart(2, '0');
    const min = String(now.getMinutes()).padStart(2, '0');
    document.getElementById('mealTime').value = `${hh}:${min}`;
  })();

  renderCards();
  updateDishSelect();
  renderDiary();
</script>
</body>
</html>
