<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Devickaya ‚Ä¢ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∏ –¥–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg: #020617;
      --bg-soft: #020617;
      --bg-elevated: #020617;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.12);
      --accent-2: #0ea5e9;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border: #1f2937;
      --danger: #ef4444;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 520px;
      padding: 16px;
    }

    .card {
      background: radial-gradient(circle at top left, #111827 0, #020617 55%);
      border-radius: 22px;
      border: 1px solid var(--border);
      padding: 16px 16px 18px;
      box-shadow: 0 24px 70px rgba(0, 0, 0, 0.85);
    }

    /* HEADER */

    .header {
      display: flex;
      gap: 12px;
      margin-bottom: 14px;
      align-items: center;
    }

    .brand-logo-wrap {
      flex-shrink: 0;
      width: 72px;
      height: 72px;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(248, 250, 252, 0.08);
      background: #111827;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .brand-logo-wrap img {
      max-width: 100%;
      height: auto;
      display: block;
    }

    .header-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .logo-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 10px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.12);
      font-size: 11px;
      color: var(--text-muted);
      align-self: flex-start;
    }

    .logo-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.35);
    }

    h1 {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.02em;
      margin: 0;
    }

    .header-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .beta-chip {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      font-size: 11px;
      color: var(--text-muted);
      align-self: flex-start;
    }

    /* TABS */

    .tabs {
      margin-top: 10px;
      display: flex;
      background: rgba(15, 23, 42, 0.95);
      border-radius: 999px;
      border: 1px solid rgba(31, 41, 55, 0.95);
      padding: 3px;
      gap: 3px;
    }

    .tab-btn {
      flex: 1;
      border: none;
      border-radius: 999px;
      background: transparent;
      color: var(--text-muted);
      padding: 8px 4px;
      font-size: 12px;
      cursor: pointer;
      transition: 0.16s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      line-height: 1.2;
    }

    .tab-btn span {
      font-size: 11px;
      opacity: 0.8;
    }

    .tab-btn.active {
      background: radial-gradient(circle at top, rgba(45, 212, 191, 0.32), rgba(15, 23, 42, 0.95));
      color: var(--text-main);
      font-weight: 500;
    }

    .tab {
      display: none;
      margin-top: 16px;
    }
    .tab.active {
      display: block;
    }

    /* FORMS */

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .field input,
    .field select,
    .field textarea {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 11px;
      border: 1px solid rgba(31, 41, 55, 0.96);
      padding: 7px 9px;
      font-size: 13px;
      color: var(--text-main);
      outline: none;
      width: 100%;
    }

    .field input::placeholder,
    .field textarea::placeholder {
      color: rgba(148, 163, 184, 0.55);
      font-size: 12px;
    }

    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      border-color: rgba(34, 197, 94, 0.7);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.35);
    }

    .field-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .field-row .field {
      flex: 1;
    }

    .hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .hint-strong {
      font-size: 11px;
      color: rgba(251, 191, 36, 0.95);
    }

    /* BUTTONS */

    .btn {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 10px 12px;
      margin-top: 12px;
      background: linear-gradient(120deg, #22c55e, #4ade80);
      color: #022c22;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: 0 10px 30px rgba(22, 163, 74, 0.5);
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 6px 18px rgba(22, 163, 74, 0.6);
    }

    .btn-ghost {
      background: transparent;
      border: 1px dashed rgba(148, 163, 184, 0.6);
      color: var(--text-muted);
      box-shadow: none;
      margin-top: 10px;
    }

    .btn-small {
      width: auto;
      padding: 6px 10px;
      font-size: 11px;
      border-radius: 999px;
    }

    .btn-danger {
      border-color: rgba(239, 68, 68, 0.75);
      color: #fecaca;
    }

    .btn-inline-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    /* RESULT CARD */

    .result-card {
      margin-top: 14px;
      padding: 10px 11px;
      border-radius: 14px;
      background: radial-gradient(circle at top left, #16a34a 0, #0f172a 48%);
      border: 1px solid rgba(34, 197, 94, 0.4);
      font-size: 13px;
    }

    .result-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-top: 4px;
    }

    .result-label {
      color: var(--text-muted);
    }

    .result-value {
      font-weight: 600;
    }

    .macros-row {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 12px;
      gap: 4px;
    }

    .macros-pill {
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(55, 65, 81, 0.95);
      flex: 1;
      text-align: center;
    }

    /* DISH CARDS */

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 7px;
      border-radius: 999px;
      font-size: 10px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(55, 65, 81, 0.96);
      color: var(--text-muted);
    }

    .pill-dot {
      width: 5px;
      height: 5px;
      border-radius: 999px;
      background: #22c55e;
    }

    .db-search-wrap {
      position: relative;
      margin-top: 4px;
    }

    .db-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 4px;
      background: rgba(15, 23, 42, 0.98);
      border-radius: 12px;
      border: 1px solid rgba(31, 41, 55, 0.95);
      max-height: 220px;
      overflow-y: auto;
      padding: 4px 0;
      z-index: 40;
    }

    .db-item {
      padding: 6px 10px;
      font-size: 12px;
      color: var(--text-main);
      cursor: pointer;
    }

    .db-item-sub {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 1px;
    }

    .db-item:hover {
      background: rgba(34, 197, 94, 0.14);
    }

    .card-preview {
      margin-top: 10px;
      padding: 10px 11px;
      border-radius: 14px;
      background: radial-gradient(circle at top left, #0ea5e9 0, #020617 52%);
      border: 1px solid rgba(59, 130, 246, 0.4);
      font-size: 13px;
    }

    .card-preview-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .cards-list {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 260px;
      overflow-y: auto;
      padding-right: 2px;
    }

    .cards-list::-webkit-scrollbar {
      width: 4px;
    }
    .cards-list::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.7);
      border-radius: 999px;
    }

    .dish-card {
      border-radius: 14px;
      padding: 9px 9px 8px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(31, 41, 55, 0.96);
    }

    .dish-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    .dish-card-title {
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .dish-card-macros {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 1px;
    }

    .dish-card-actions {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    /* DIARY */

    .period-toggle {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid rgba(31, 41, 55, 0.96);
      overflow: hidden;
      background: rgba(15, 23, 42, 0.96);
      margin-bottom: 10px;
    }

    .period-btn {
      border: none;
      padding: 6px 12px;
      font-size: 11px;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
    }

    .period-btn.active {
      background: rgba(34, 197, 94, 0.16);
      color: var(--text-main);
      font-weight: 500;
    }

    .day-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
      margin-top: 4px;
    }

    .day-nav-btn {
      background: transparent;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.96);
      color: var(--text-muted);
      padding: 4px 8px;
      font-size: 11px;
      cursor: pointer;
    }

    .day-nav-label {
      font-size: 12px;
      color: var(--text-main);
      text-align: center;
      flex: 1;
      margin: 0 6px;
    }

    .diary-summary {
      margin-top: 6px;
      padding: 8px 10px;
      border-radius: 14px;
      background: radial-gradient(circle at top right, rgba(250, 204, 21, 0.24), #020617 60%);
      border: 1px solid rgba(234, 179, 8, 0.55);
      font-size: 12px;
    }

    .diary-summary-main {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
    }

    .diary-summary-macros {
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .meal-section-title {
      margin-top: 10px;
      margin-bottom: 4px;
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .meal-card {
      border-radius: 14px;
      padding: 8px 9px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(31, 41, 55, 0.96);
      margin-bottom: 6px;
      font-size: 12px;
    }

    .meal-card-top {
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }

    .meal-card-name {
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .meal-card-time {
      font-size: 11px;
      color: var(--text-muted);
    }

    .meal-card-macros {
      margin-top: 2px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .meal-card-actions {
      margin-top: 4px;
      display: flex;
      justify-content: flex-end;
      gap: 6px;
    }

    .period-days-list {
      margin-top: 10px;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 260px;
      overflow-y: auto;
      padding-right: 2px;
    }

    .period-day-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 9px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(31, 41, 55, 0.96);
      cursor: pointer;
    }

    .period-day-row:hover {
      border-color: rgba(34, 197, 94, 0.5);
    }

    .period-day-date {
      font-size: 12px;
    }

    .period-day-kcal {
      font-size: 12px;
      font-weight: 500;
    }

    /* ETC */

    .empty-state {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    @media (max-width: 420px) {
      .card {
        border-radius: 20px;
      }
      h1 {
        font-size: 17px;
      }
      .brand-logo-wrap {
        width: 64px;
        height: 64px;
      }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="card">
      <!-- HEADER -->
      <div class="header">
        <div class="brand-logo-wrap">
          <!-- –õ–æ–≥–æ—Ç–∏–ø –±—Ä–µ–Ω–¥–∞ –≤ –∫–æ—Ä–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è -->
          <img src="brand-logo-devickaya.png" alt="–≠–Ω–¥–æ–∫—Ä–∏–Ω–æ–ª–æ–≥-–Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥ –î–µ–≤–∏—Ü–∫–∞—è –ï–∫–∞—Ç–µ—Ä–∏–Ω–∞ –í–ª–∞–¥–∏–º–∏—Ä–æ–≤–Ω–∞">
        </div>
        <div class="header-main">
          <div class="logo-pill">
            <span class="logo-dot"></span>
            Devickaya ‚Ä¢ MiniApp
          </div>
          <h1>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∫–∞–ª–æ—Ä–∏–π & –¥–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è</h1>
          <div class="header-subtitle">
            –ü–æ—Å—á–∏—Ç–∞–π –Ω–æ—Ä–º—É, —Å–æ—Ö—Ä–∞–Ω–∏ —Å–≤–æ–∏ –±–ª—é–¥–∞ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π –ø—Ä–∏—ë–º—ã –ø–∏—â–∏ –ø–æ –¥–Ω—è–º
          </div>
        </div>
        <div class="beta-chip">beta</div>
      </div>

      <!-- TABS -->
      <div class="tabs">
        <button class="tab-btn active" data-tab="tab-calculator">
          –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
          <span>–Ω–æ—Ä–º–∞ –∫–∞–ª–æ—Ä–∏–π</span>
        </button>
        <button class="tab-btn" data-tab="tab-dishes">
          –ö–∞—Ä—Ç–æ—á–∫–∏ –±–ª—é–¥
          <span>–ö–ë–ñ–£ & –ø–æ—Ä—Ü–∏—è</span>
        </button>
        <button class="tab-btn" data-tab="tab-diary">
          –î–Ω–µ–≤–Ω–∏–∫
          <span>–¥–µ–Ω—å / –Ω–µ–¥–µ–ª—è / –º–µ—Å—è—Ü</span>
        </button>
      </div>

      <!-- TAB: CALCULATOR -->
      <div id="tab-calculator" class="tab active">
        <div class="form-grid" style="margin-top: 12px">
          <div class="field">
            <label for="gender">–ü–æ–ª</label>
            <select id="gender">
              <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
              <option value="male">–ú—É–∂—Å–∫–æ–π</option>
            </select>
          </div>
          <div class="field">
            <label for="age">–í–æ–∑—Ä–∞—Å—Ç, –ª–µ—Ç</label>
            <input id="age" type="number" min="10" max="100" inputmode="numeric" />
          </div>

          <div class="field">
            <label for="height">–†–æ—Å—Ç, —Å–º</label>
            <input id="height" type="number" min="120" max="230" inputmode="numeric" />
          </div>
          <div class="field">
            <label for="weight">–í–µ—Å, –∫–≥</label>
            <input id="weight" type="number" min="30" max="250" inputmode="decimal" />
          </div>

          <div class="field">
            <label for="activity">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</label>
            <select id="activity">
              <option value="1.2">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è</option>
              <option value="1.375">1‚Äì3 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏/–Ω–µ–¥</option>
              <option value="1.55">3‚Äì5 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫/–Ω–µ–¥</option>
              <option value="1.725">–ö–∞–∂–¥—ã–π –¥–µ–Ω—å</option>
              <option value="1.9">–°–ø–æ—Ä—Ç 2 —Ä–∞–∑–∞ –≤ –¥–µ–Ω—å</option>
            </select>
          </div>

          <div class="field">
            <label for="goal">–¶–µ–ª—å</label>
            <select id="goal">
              <option value="loss">–ü–æ—Ö—É–¥–µ–Ω–∏–µ</option>
              <option value="keep">–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ</—Ç–∏>
              <option value="gain">–ù–∞–±–æ—Ä</option>
            </select>
          </div>
        </div>

        <div class="field-row">
          <div class="field">
            <label for="intensity">–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å</label>
            <select id="intensity">
              <option value="mild">–ú—è–≥–∫–æ</option>
              <option value="normal" selected>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ</option>
              <option value="aggressive">–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ</option>
            </select>
          </div>
          <div class="field">
            <label for="protein-per-kg">–ë–µ–ª–æ–∫, –≥/–∫–≥</label>
            <input id="protein-per-kg" type="number" step="0.1" value="1.6" />
          </div>
        </div>

        <div class="hint">
          –†–∞—Å—á—ë—Ç –ø–æ —Ñ–æ—Ä–º—É–ª–µ Mifflin‚ÄìSt Jeor. –≠—Ç–æ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–µ
          –∑–∞–º–µ–Ω—è—é—Ç –æ—á–Ω—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –≤—Ä–∞—á–∞.
        </div>

        <button id="btn-calc" class="btn">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –Ω–æ—Ä–º—É –∫–∞–ª–æ—Ä–∏–π</button>

        <div id="calc-result" class="result-card" style="display: none">
          <div class="result-row">
            <div class="result-label">–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–µ—Å–∞:</div>
            <div class="result-value" id="cal-maintain"></div>
          </div>
          <div class="result-row">
            <div class="result-label">–¶–µ–ª–µ–≤–∞—è –Ω–æ—Ä–º–∞:</div>
            <div class="result-value" id="cal-target"></div>
          </div>
          <div class="macros-row">
            <div class="macros-pill">–ë: <span id="macro-protein"></span> –≥</div>
            <div class="macros-pill">–ñ: <span id="macro-fat"></span> –≥</div>
            <div class="macros-pill">–£: <span id="macro-carbs"></span> –≥</div>
          </div>
        </div>
      </div>

      <!-- TAB: DISH CARDS -->
      <div id="tab-dishes" class="tab">
        <!-- –ü–æ–∏—Å–∫ –ø–æ –±–∞–∑–µ –±–ª—é–¥ -->
        <div class="field db-search-wrap">
          <label for="db-search">–í—ã–±—Ä–∞—Ç—å –±–ª—é–¥–æ –∏–∑ –±–∞–∑—ã</label>
          <input id="db-search" type="text" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –≤–∞—à–µ–π –±–∞–∑—ã" />
          <div id="db-dropdown" class="db-dropdown" style="display: none"></div>
        </div>
        <div class="hint">
          –ë–∞–∑–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∏–∑ —Ñ–∞–π–ª–∞ <strong>dish_db_from_excel.js</strong> –≤ –∫–æ—Ä–Ω–µ.
          –í—ã –º–æ–∂–µ—Ç–µ –æ–±–Ω–æ–≤–ª—è—Ç—å –µ—ë –æ—Ç–¥–µ–ª—å–Ω–æ ‚Äì –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏
          —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–≥—Ä—É–∑–∫–µ.
        </div>

        <!-- –†—É—á–Ω–æ–π –≤–≤–æ–¥ / —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
        <div class="field" style="margin-top: 12px">
          <label for="dish-name">–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞ / –ø—Ä–æ–¥—É–∫—Ç–∞</label>
          <input id="dish-name" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û–≤—Å—è–Ω–∞—è –∫–∞—à–∞ –Ω–∞ –≤–æ–¥–µ" />
        </div>

        <div class="field-row">
          <div class="field">
            <label for="dish-protein">–ë–µ–ª–∫–∏, –≥ / 100 –≥</label>
            <input id="dish-protein" type="number" step="0.1" />
          </div>
          <div class="field">
            <label for="dish-fat">–ñ–∏—Ä—ã, –≥ / 100 –≥</label>
            <input id="dish-fat" type="number" step="0.1" />
          </div>
        </div>

        <div class="field-row">
          <div class="field">
            <label for="dish-carbs">–£–≥–ª–µ–≤–æ–¥—ã, –≥ / 100 –≥</label>
            <input id="dish-carbs" type="number" step="0.1" />
          </div>
          <div class="field">
            <label for="dish-kcal">–ö–∞–ª–æ—Ä–∏–∏, –∫–∫–∞–ª / 100 –≥</label>
            <input id="dish-kcal" type="number" step="1" />
          </div>
        </div>

        <div class="field" style="margin-top: 10px">
          <label for="dish-weight">–ú–∞—Å—Å–∞ –ø–æ—Ä—Ü–∏–∏, –≥</label>
          <input id="dish-weight" type="number" step="1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 200" />
        </div>

        <div class="hint">
          –ï—Å–ª–∏ –∫–∞–ª–æ—Ä–∏–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã, –æ–Ω–∏ –±—É–¥—É—Ç –ø–æ—Å—á–∏—Ç–∞–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –ë–ñ–£
          –ø–æ —Ñ–æ—Ä–º—É–ª–µ 4/9/4.
        </div>

        <!-- Preview -->
        <div id="dish-preview" class="card-preview" style="display: none">
          <div class="card-preview-title" id="preview-title"></div>
          <div id="preview-100g"></div>
          <div id="preview-portion"></div>
        </div>

        <button id="btn-add-dish" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –±–ª—é–¥–∞</button>

        <button id="btn-clear-all-dishes" class="btn btn-ghost btn-small btn-danger">
          –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
        </button>

        <!-- List -->
        <div class="cards-list" id="cards-list"></div>
      </div>

      <!-- TAB: DIARY -->
      <div id="tab-diary" class="tab">
        <div class="period-toggle">
          <button class="period-btn active" data-period="day">–î–µ–Ω—å</button>
          <button class="period-btn" data-period="week">–ù–µ–¥–µ–ª—è</button>
          <button class="period-btn" data-period="month">–ú–µ—Å—è—Ü</button>
        </div>

        <div class="day-nav" id="day-nav">
          <button class="day-nav-btn" id="prev-day">&larr;</button>
          <div class="day-nav-label" id="day-label"></div>
          <button class="day-nav-btn" id="next-day">&rarr;</button>
        </div>

        <div id="diary-summary" class="diary-summary" style="display:none">
          <div class="diary-summary-main">
            <span id="summary-period-label"></span>
            <span id="summary-kcal"></span>
          </div>
          <div class="diary-summary-macros" id="summary-macros"></div>
        </div>

        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏ (—Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ "–î–µ–Ω—å") -->
        <div id="diary-add-form-wrap">
          <div class="meal-section-title">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏—ë–º –ø–∏—â–∏</div>
          <div class="field-row">
            <div class="field">
              <label for="meal-type">–¢–∏–ø –ø—Ä–∏—ë–º–∞</label>
              <select id="meal-type">
                <option value="breakfast">–ó–∞–≤—Ç—Ä–∞–∫</option>
                <option value="lunch">–û–±–µ–¥</option>
                <option value="dinner">–£–∂–∏–Ω</option>
                <option value="snack">–ü–µ—Ä–µ–∫—É—Å</option>
              </select>
            </div>
            <div class="field">
              <label for="meal-time">–í—Ä–µ–º—è</label>
              <input id="meal-time" type="time" />
            </div>
          </div>

          <div class="field">
            <label for="meal-dish">–ë–ª—é–¥–æ (–∏–∑ –∫–∞—Ä—Ç–æ—á–µ–∫ –∏–ª–∏ —Å–≤–æ—ë)</label>
            <select id="meal-dish"></select>
          </div>

          <div class="field" style="margin-top: 8px">
            <label for="meal-portion">–ú–∞—Å—Å–∞ –ø–æ—Ä—Ü–∏–∏, –≥</label>
            <input id="meal-portion" type="number" step="1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 200" />
          </div>

          <div class="hint">
            –î–ª—è –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–∞—Ä—Ç–æ—á–µ–∫ –±–ª—é–¥. –ï—Å–ª–∏ –≤—ã–±—Ä–∞—Ç—å
            –≤–∞—Ä–∏–∞–Ω—Ç ¬´–°–≤–æ–µ –±–ª—é–¥–æ¬ª, –º–∞–∫—Ä–æ—Å—ã –±—É–¥—É—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã —Ç–æ–ª—å–∫–æ –ø–æ –≤–≤–µ–¥—ë–Ω–Ω—ã–º
            –¥–∞–Ω–Ω—ã–º.
          </div>

          <button id="btn-add-meal" class="btn btn-small" style="margin-top:10px">
            –î–æ–±–∞–≤–∏—Ç—å –≤ –¥–Ω–µ–≤–Ω–∏–∫
          </button>
        </div>

        <div id="diary-day-list"></div>

        <!-- –°–ø–∏—Å–æ–∫ –¥–Ω–µ–π –¥–ª—è –ø–µ—Ä–∏–æ–¥–æ–≤ "–ù–µ–¥–µ–ª—è" / "–ú–µ—Å—è—Ü" -->
        <div id="period-days" style="display:none"></div>
      </div>
    </div>
  </div>

  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∞–∑—É –±–ª—é–¥ –∏–∑ –∫–æ—Ä–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è -->
  <script src="dish_db_from_excel.js"></script>

  <script>
    // ==== Telegram WebApp init (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –∏–∑ –¢–µ–ª–µ–≥—Ä–∞–º–∞) ====
    (function initTelegram() {
      try {
        var tg = window.Telegram && window.Telegram.WebApp;
        if (!tg) return;
        tg.expand();
        tg.ready();
        if (tg.backgroundColor) {
          document.body.style.backgroundColor = tg.backgroundColor;
        }
      } catch (e) {
        console.log("Telegram WebApp init error:", e);
      }
    })();

    // ==== HELPERS ====
    function round(num) {
      return Math.round(num);
    }
    function round1(num) {
      return Math.round(num * 10) / 10;
    }

    function formatDateISO(date) {
      return date.toISOString().slice(0, 10);
    }

    function parseISODate(str) {
      var parts = str.split("-");
      return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
    }

    function formatDateNice(date, todayStr) {
      var iso = formatDateISO(date);
      if (iso === todayStr) return "–°–µ–≥–æ–¥–Ω—è";
      var opts = { day: "numeric", month: "long" };
      return date.toLocaleDateString("ru-RU", opts);
    }

    function uuid() {
      return Date.now().toString(36) + "_" + Math.random().toString(36).substr(2, 6);
    }

    // ==== TABS ====
    var tabButtons = document.querySelectorAll(".tab-btn");
    var tabs = document.querySelectorAll(".tab");

    tabButtons.forEach(function (btn) {
      btn.addEventListener("click", function () {
        var tabId = btn.dataset.tab;
        tabButtons.forEach(function (b) {
          b.classList.remove("active");
        });
        tabs.forEach(function (t) {
          t.classList.remove("active");
        });
        btn.classList.add("active");
        document.getElementById(tabId).classList.add("active");
      });
    });

    // ==== CALCULATOR ====
    var genderEl = document.getElementById("gender");
    var ageEl = document.getElementById("age");
    var heightEl = document.getElementById("height");
    var weightEl = document.getElementById("weight");
    var activityEl = document.getElementById("activity");
    var goalEl = document.getElementById("goal");
    var intensityEl = document.getElementById("intensity");
    var proteinPerKgEl = document.getElementById("protein-per-kg");

    var btnCalc = document.getElementById("btn-calc");
    var resultWrap = document.getElementById("calc-result");
    var calMaintainEl = document.getElementById("cal-maintain");
    var calTargetEl = document.getElementById("cal-target");
    var macroProteinEl = document.getElementById("macro-protein");
    var macroFatEl = document.getElementById("macro-fat");
    var macroCarbsEl = document.getElementById("macro-carbs");

    btnCalc.addEventListener("click", function () {
      var gender = genderEl.value;
      var age = parseFloat(ageEl.value);
      var height = parseFloat(heightEl.value);
      var weight = parseFloat(weightEl.value);
      var activity = parseFloat(activityEl.value);
      var goal = goalEl.value;
      var intensity = intensityEl.value;
      var proteinPerKg = parseFloat(proteinPerKgEl.value || "1.6");

      if (!age || !height || !weight || !activity) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç, —Ä–æ—Å—Ç, –≤–µ—Å –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.");
        return;
      }

      var bmr;
      if (gender === "male") {
        bmr = 10 * weight + 6.25 * height - 5 * age + 5;
      } else {
        bmr = 10 * weight + 6.25 * height - 5 * age - 161;
      }

      var maintain = bmr * activity;

      var delta = 0;
      if (goal === "loss") {
        if (intensity === "mild") delta = -0.1;
        else if (intensity === "aggressive") delta = -0.25;
        else delta = -0.18;
      } else if (goal === "gain") {
        if (intensity === "mild") delta = 0.1;
        else if (intensity === "aggressive") delta = 0.25;
        else delta = 0.18;
      }

      var target = maintain * (1 + delta);

      var protein = weight * proteinPerKg;
      var fat = (target * 0.25) / 9;
      var carbs = (target - protein * 4 - fat * 9) / 4;

      calMaintainEl.textContent = round(maintain) + " –∫–∫–∞–ª";
      calTargetEl.textContent = round(target) + " –∫–∫–∞–ª";
      macroProteinEl.textContent = round(protein);
      macroFatEl.textContent = round(fat);
      macroCarbsEl.textContent = round(carbs);

      resultWrap.style.display = "block";
    });

    // ==== DISH CARDS STORAGE ====
    var DISH_CARDS_STORAGE_KEY = "miniappcalors_dish_cards_v1";
    function loadDishCards() {
      try {
        var raw = localStorage.getItem(DISH_CARDS_STORAGE_KEY);
        if (!raw) return [];
        return JSON.parse(raw) || [];
      } catch (e) {
        console.log("Dish cards parse error", e);
        return [];
      }
    }
    function saveDishCards(list) {
      localStorage.setItem(DISH_CARDS_STORAGE_KEY, JSON.stringify(list));
      updateMealDishSelect();
    }

    // ==== DISH DB FROM EXCEL ====
    // –û–∂–∏–¥–∞–µ–º, —á—Ç–æ dish_db_from_excel.js —Å–æ–∑–¥–∞—ë—Ç –æ–¥–∏–Ω –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –º–∞—Å—Å–∏–≤–æ–≤:
    // window.DISH_DB, window.dish_db, window.dishes, window.dishDb
    function getDishDb() {
      var db =
        window.DISH_DB ||
        window.dish_db ||
        window.dishes ||
        window.dishDb ||
        [];
      if (!Array.isArray(db)) return [];
      return db;
    }

    // –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∏–∑ –±–∞–∑—ã –∫ –µ–¥–∏–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É
    // –û–∂–∏–¥–∞–µ–º—ã–µ –ø–æ–ª—è: name (–∏–ª–∏ title), protein, fat, carbs, kcal / energy
    function normalizeDishFromDb(item) {
      if (!item) return null;
      var name = item.name || item.title || item.product || "";
      var protein = parseFloat(item.protein || item.p || item.b || 0) || 0;
      var fat = parseFloat(item.fat || item.j || item.f || 0) || 0;
      var carbs = parseFloat(item.carbs || item.u || item.c || 0) || 0;
      var kcal =
        parseFloat(item.kcal || item.energy || item.calories || 0) ||
        (protein * 4 + fat * 9 + carbs * 4);
      if (!name) return null;
      return {
        name: name,
        protein: protein,
        fat: fat,
        carbs: carbs,
        kcal: kcal
      };
    }

    // ==== DISH CARDS UI ====
    var dishNameEl = document.getElementById("dish-name");
    var dishProteinEl = document.getElementById("dish-protein");
    var dishFatEl = document.getElementById("dish-fat");
    var dishCarbsEl = document.getElementById("dish-carbs");
    var dishKcalEl = document.getElementById("dish-kcal");
    var dishWeightEl = document.getElementById("dish-weight");

    var previewWrap = document.getElementById("dish-preview");
    var previewTitleEl = document.getElementById("preview-title");
    var preview100gEl = document.getElementById("preview-100g");
    var previewPortionEl = document.getElementById("preview-portion");

    var btnAddDish = document.getElementById("btn-add-dish");
    var btnClearAllDishes = document.getElementById("btn-clear-all-dishes");
    var cardsListEl = document.getElementById("cards-list");

    function updateDishPreview() {
      var name = dishNameEl.value.trim();
      var p = parseFloat(dishProteinEl.value || "0");
      var f = parseFloat(dishFatEl.value || "0");
      var c = parseFloat(dishCarbsEl.value || "0");
      var k = parseFloat(dishKcalEl.value || "0");
      var w = parseFloat(dishWeightEl.value || "0");

      if (!name || (!p && !f && !c && !k)) {
        previewWrap.style.display = "none";
        return;
      }

      if (!k) {
        k = p * 4 + f * 9 + c * 4;
      }

      previewWrap.style.display = "block";
      previewTitleEl.textContent = name;
      preview100gEl.textContent =
        "100 –≥: –ë " +
        p.toFixed(1) +
        " –≥ ‚Ä¢ –ñ " +
        f.toFixed(1) +
        " –≥ ‚Ä¢ –£ " +
        c.toFixed(1) +
        " –≥ ‚Ä¢ " +
        k.toFixed(0) +
        " –∫–∫–∞–ª";

      if (w > 0) {
        var mult = w / 100;
        var p2 = p * mult;
        var f2 = f * mult;
        var c2 = c * mult;
        var k2 = k * mult;
        previewPortionEl.textContent =
          w.toFixed(0) +
          " –≥: –ë " +
          p2.toFixed(1) +
          " –≥ ‚Ä¢ –ñ " +
          f2.toFixed(1) +
          " –≥ ‚Ä¢ –£ " +
          c2.toFixed(1) +
          " –≥ ‚Ä¢ " +
          k2.toFixed(0) +
          " –∫–∫–∞–ª";
      } else {
        previewPortionEl.textContent = "–ü–æ—Ä—Ü–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞";
      }
    }

    [dishNameEl, dishProteinEl, dishFatEl, dishCarbsEl, dishKcalEl, dishWeightEl].forEach(
      function (el) {
        el.addEventListener("input", updateDishPreview);
      }
    );

    function renderDishCards() {
      var dishes = loadDishCards();
      cardsListEl.innerHTML = "";
      if (!dishes.length) {
        var empty = document.createElement("div");
        empty.className = "empty-state";
        empty.textContent =
          "–ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –±–ª—é–¥. –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–æ –æ–¥–Ω–æ–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ª—é–±–∏–º–æ–≥–æ –±–ª—é–¥–∞.";
        cardsListEl.appendChild(empty);
        return;
      }

      dishes.forEach(function (dish, index) {
        var card = document.createElement("div");
        card.className = "dish-card";

        var header = document.createElement("div");
        header.className = "dish-card-header";

        var title = document.createElement("div");
        title.className = "dish-card-title";
        title.textContent = dish.name;

        var pill = document.createElement("div");
        pill.className = "pill";
        var label =
          dish.portionWeight && dish.portionWeight > 0
            ? dish.portionWeight.toFixed(0) + " –≥ –ø–æ—Ä—Ü–∏—è"
            : "100 –≥";
        pill.innerHTML = '<span class="pill-dot"></span>' + label;

        header.appendChild(title);
        header.appendChild(pill);
        card.appendChild(header);

        var macros100 = document.createElement("div");
        macros100.className = "dish-card-macros";
        macros100.textContent =
          "100 –≥: –ë " +
          dish.protein.toFixed(1) +
          " ‚Ä¢ –ñ " +
          dish.fat.toFixed(1) +
          " ‚Ä¢ –£ " +
          dish.carbs.toFixed(1) +
          " ‚Ä¢ " +
          dish.kcal.toFixed(0) +
          " –∫–∫–∞–ª";
        card.appendChild(macros100);

        var macrosPortion = document.createElement("div");
        macrosPortion.className = "dish-card-macros";
        if (dish.portionWeight && dish.portionWeight > 0) {
          var mult = dish.portionWeight / 100;
          var p2 = dish.protein * mult;
          var f2 = dish.fat * mult;
          var c2 = dish.carbs * mult;
          var k2 = dish.kcal * mult;
          macrosPortion.textContent =
            dish.portionWeight.toFixed(0) +
            " –≥: –ë " +
            p2.toFixed(1) +
            " ‚Ä¢ –ñ " +
            f2.toFixed(1) +
            " ‚Ä¢ –£ " +
            c2.toFixed(1) +
            " ‚Ä¢ " +
            k2.toFixed(0) +
            " –∫–∫–∞–ª";
        } else {
          macrosPortion.textContent = "–ü–æ—Ä—Ü–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞";
        }
        card.appendChild(macrosPortion);

        var actions = document.createElement("div");
        actions.className = "dish-card-actions";

        var btnCopy = document.createElement("button");
        btnCopy.className = "btn-small btn-ghost";
        btnCopy.textContent = "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å";
        btnCopy.addEventListener("click", function () {
          var text =
            "üçΩ " +
            dish.name +
            "\n" +
            "100 –≥: –ë " +
            dish.protein.toFixed(1) +
            " –≥, –ñ " +
            dish.fat.toFixed(1) +
            " –≥, –£ " +
            dish.carbs.toFixed(1) +
            " –≥, " +
            dish.kcal.toFixed(0) +
            " –∫–∫–∞–ª";
          if (dish.portionWeight && dish.portionWeight > 0) {
            var mult = dish.portionWeight / 100;
            var p2 = dish.protein * mult;
            var f2 = dish.fat * mult;
            var c2 = dish.carbs * mult;
            var k2 = dish.kcal * mult;
            text +=
              "\n" +
              dish.portionWeight.toFixed(0) +
              " –≥: –ë " +
              p2.toFixed(1) +
              " –≥, –ñ " +
              f2.toFixed(1) +
              " –≥, –£ " +
              c2.toFixed(1) +
              " –≥, " +
              k2.toFixed(0) +
              " –∫–∫–∞–ª";
          }
          navigator.clipboard.writeText(text).then(
            function () {
              alert("–¢–µ–∫—Å—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ ‚úÖ");
            },
            function () {
              alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç :(");
            }
          );
        });
        actions.appendChild(btnCopy);

        var btnDelete = document.createElement("button");
        btnDelete.className = "btn-small btn-ghost btn-danger";
        btnDelete.textContent = "–£–¥–∞–ª–∏—Ç—å";
        btnDelete.addEventListener("click", function () {
          var list = loadDishCards();
          list.splice(index, 1);
          saveDishCards(list);
          renderDishCards();
        });
        actions.appendChild(btnDelete);

        card.appendChild(actions);
        cardsListEl.appendChild(card);
      });
    }

    btnAddDish.addEventListener("click", function () {
      var name = dishNameEl.value.trim();
      var p = parseFloat(dishProteinEl.value || "0");
      var f = parseFloat(dishFatEl.value || "0");
      var c = parseFloat(dishCarbsEl.value || "0");
      var k = parseFloat(dishKcalEl.value || "0");
      var w = parseFloat(dishWeightEl.value || "0");

      if (!name) {
        alert("–î–æ–±–∞–≤—å –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞.");
        return;
      }
      if (!p && !f && !c && !k) {
        alert("–ó–∞–ø–æ–ª–Ω–∏ —Ö–æ—Ç—è –±—ã –ö–ë–ñ–£ –∏–ª–∏ –∫–∞–ª–æ—Ä–∏–∏.");
        return;
      }
      if (!k) {
        k = p * 4 + f * 9 + c * 4;
      }

      var list = loadDishCards();
      list.unshift({
        id: uuid(),
        name: name,
        protein: p || 0,
        fat: f || 0,
        carbs: c || 0,
        kcal: k || 0,
        portionWeight: w || null
      });
      saveDishCards(list);

      dishNameEl.value = "";
      dishProteinEl.value = "";
      dishFatEl.value = "";
      dishCarbsEl.value = "";
      dishKcalEl.value = "";
      dishWeightEl.value = "";
      previewWrap.style.display = "none";

      renderDishCards();
    });

    btnClearAllDishes.addEventListener("click", function () {
      if (!confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –±–ª—é–¥?")) return;
      saveDishCards([]);
      renderDishCards();
    });

    // ==== DISH DB AUTOCOMPLETE ====
    var dbSearchEl = document.getElementById("db-search");
    var dbDropdownEl = document.getElementById("db-dropdown");
    var cachedDb = null;

    function ensureDbLoaded() {
      if (!cachedDb) {
        cachedDb = getDishDb()
          .map(normalizeDishFromDb)
          .filter(Boolean);
      }
      return cachedDb;
    }

    dbSearchEl.addEventListener("input", function () {
      var query = dbSearchEl.value.trim().toLowerCase();
      var db = ensureDbLoaded();
      if (!query || !db.length) {
        dbDropdownEl.style.display = "none";
        return;
      }
      var matches = db.filter(function (item) {
        return item.name.toLowerCase().indexOf(query) !== -1;
      });

      if (!matches.length) {
        dbDropdownEl.style.display = "none";
        return;
      }

      dbDropdownEl.innerHTML = "";
      matches.slice(0, 25).forEach(function (item) {
        var row = document.createElement("div");
        row.className = "db-item";
        row.innerHTML =
          '<div>' +
          item.name +
          "</div>" +
          '<div class="db-item-sub">–ë ' +
          item.protein.toFixed(1) +
          " ‚Ä¢ –ñ " +
          item.fat.toFixed(1) +
          " ‚Ä¢ –£ " +
          item.carbs.toFixed(1) +
          " ‚Ä¢ " +
          item.kcal.toFixed(0) +
          " –∫–∫–∞–ª</div>";
        row.addEventListener("click", function () {
          dbSearchEl.value = item.name;
          dishNameEl.value = item.name;
          dishProteinEl.value = item.protein.toFixed(1);
          dishFatEl.value = item.fat.toFixed(1);
          dishCarbsEl.value = item.carbs.toFixed(1);
          dishKcalEl.value = item.kcal.toFixed(0);
          updateDishPreview();
          dbDropdownEl.style.display = "none";
        });
        dbDropdownEl.appendChild(row);
      });
      dbDropdownEl.style.display = "block";
    });

    document.addEventListener("click", function (e) {
      if (!dbSearchEl.contains(e.target) && !dbDropdownEl.contains(e.target)) {
        dbDropdownEl.style.display = "none";
      }
    });

    // ==== DIARY STORAGE ====
    var DIARY_STORAGE_KEY = "miniappcalors_diary_v1";
    function loadDiary() {
      try {
        var raw = localStorage.getItem(DIARY_STORAGE_KEY);
        if (!raw) return [];
        return JSON.parse(raw) || [];
      } catch (e) {
        console.log("Diary parse error", e);
        return [];
      }
    }
    function saveDiary(list) {
      localStorage.setItem(DIARY_STORAGE_KEY, JSON.stringify(list));
    }

    // ==== DIARY UI ====
    var periodBtns = document.querySelectorAll(".period-btn");
    var periodDaysEl = document.getElementById("period-days");
    var diaryDayListEl = document.getElementById("diary-day-list");
    var diarySummaryEl = document.getElementById("diary-summary");
    var summaryPeriodLabelEl = document.getElementById("summary-period-label");
    var summaryKcalEl = document.getElementById("summary-kcal");
    var summaryMacrosEl = document.getElementById("summary-macros");

    var dayNav = document.getElementById("day-nav");
    var prevDayBtn = document.getElementById("prev-day");
    var nextDayBtn = document.getElementById("next-day");
    var dayLabelEl = document.getElementById("day-label");

    var diaryAddFormWrap = document.getElementById("diary-add-form-wrap");
    var mealTypeEl = document.getElementById("meal-type");
    var mealTimeEl = document.getElementById("meal-time");
    var mealDishEl = document.getElementById("meal-dish");
    var mealPortionEl = document.getElementById("meal-portion");
    var btnAddMeal = document.getElementById("btn-add-meal");

    var todayIso = formatDateISO(new Date());
    var currentPeriod = "day";
    var currentDay = todayIso;

    function updateDayLabel() {
      var date = parseISODate(currentDay);
      dayLabelEl.textContent = formatDateNice(date, todayIso) + ", " + currentDay;
    }

    prevDayBtn.addEventListener("click", function () {
      var d = parseISODate(currentDay);
      d.setDate(d.getDate() - 1);
      currentDay = formatDateISO(d);
      renderDiary();
    });

    nextDayBtn.addEventListener("click", function () {
      var d = parseISODate(currentDay);
      d.setDate(d.getDate() + 1);
      currentDay = formatDateISO(d);
      renderDiary();
    });

    periodBtns.forEach(function (btn) {
      btn.addEventListener("click", function () {
        currentPeriod = btn.dataset.period;
        periodBtns.forEach(function (b) {
          b.classList.remove("active");
        });
        btn.classList.add("active");
        renderDiary();
      });
    });

    function computeTotals(entries) {
      var totalKcal = 0,
        totalP = 0,
        totalF = 0,
        totalC = 0;
      entries.forEach(function (e) {
        totalKcal += e.portionKcal || 0;
        totalP += e.portionProtein || 0;
        totalF += e.portionFat || 0;
        totalC += e.portionCarbs || 0;
      });
      return {
        kcal: totalKcal,
        p: totalP,
        f: totalF,
        c: totalC
      };
    }

    function groupDiaryByDate(list) {
      var map = {};
      list.forEach(function (e) {
        if (!map[e.date]) map[e.date] = [];
        map[e.date].push(e);
      });
      return map;
    }

    function renderDiary() {
      var diary = loadDiary();
      updateDayLabel();

      if (currentPeriod === "day") {
        dayNav.style.display = "flex";
        diaryAddFormWrap.style.display = "block";
        periodDaysEl.style.display = "none";

        var dayEntries = diary.filter(function (e) {
          return e.date === currentDay;
        });

        var totals = computeTotals(dayEntries);
        if (dayEntries.length) {
          diarySummaryEl.style.display = "block";
          summaryPeriodLabelEl.textContent = "–ò—Ç–æ–≥ –∑–∞ –¥–µ–Ω—å";
          summaryKcalEl.textContent = round(totals.kcal) + " –∫–∫–∞–ª";
          summaryMacrosEl.textContent =
            "–ë " +
            round(totals.p) +
            " –≥ ‚Ä¢ –ñ " +
            round(totals.f) +
            " –≥ ‚Ä¢ –£ " +
            round(totals.c) +
            " –≥";
        } else {
          diarySummaryEl.style.display = "none";
        }

        // —Å–ø–∏—Å–æ–∫ –ø—Ä–∏—ë–º–æ–≤
        diaryDayListEl.innerHTML = "";
        if (!dayEntries.length) {
          var empty = document.createElement("div");
          empty.className = "empty-state";
          empty.textContent =
            "–ó–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π. –î–æ–±–∞–≤—å –ø–µ—Ä–≤—ã–π –ø—Ä–∏—ë–º –ø–∏—â–∏ ‚ú®";
          diaryDayListEl.appendChild(empty);
        } else {
          var typesOrder = [
            { key: "breakfast", label: "–ó–∞–≤—Ç—Ä–∞–∫" },
            { key: "lunch", label: "–û–±–µ–¥" },
            { key: "dinner", label: "–£–∂–∏–Ω" },
            { key: "snack", label: "–ü–µ—Ä–µ–∫—É—Å—ã" }
          ];
          typesOrder.forEach(function (typeInfo) {
            var group = dayEntries.filter(function (e) {
              return e.mealType === typeInfo.key;
            });
            if (!group.length) return;
            var title = document.createElement("div");
            title.className = "meal-section-title";
            title.textContent = typeInfo.label;
            diaryDayListEl.appendChild(title);

            group.forEach(function (entry, idx) {
              var card = document.createElement("div");
              card.className = "meal-card";

              var top = document.createElement("div");
              top.className = "meal-card-top";
              var nameEl = document.createElement("div");
              nameEl.className = "meal-card-name";
              nameEl.textContent = entry.name;
              var timeEl = document.createElement("div");
              timeEl.className = "meal-card-time";
              timeEl.textContent = entry.time || "";
              top.appendChild(nameEl);
              top.appendChild(timeEl);
              card.appendChild(top);

              var macrosLine = document.createElement("div");
              macrosLine.className = "meal-card-macros";
              macrosLine.textContent =
                (entry.portionWeight
                  ? entry.portionWeight.toFixed(0) + " –≥ ‚Äî "
                  : "") +
                "–ë " +
                round1(entry.portionProtein || 0) +
                " ‚Ä¢ –ñ " +
                round1(entry.portionFat || 0) +
                " ‚Ä¢ –£ " +
                round1(entry.portionCarbs || 0) +
                " ‚Ä¢ " +
                round1(entry.portionKcal || 0) +
                " –∫–∫–∞–ª";
              card.appendChild(macrosLine);

              var actions = document.createElement("div");
              actions.className = "meal-card-actions";
              var delBtn = document.createElement("button");
              delBtn.className = "btn-small btn-ghost btn-danger";
              delBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
              delBtn.addEventListener("click", function () {
                var list = loadDiary();
                var indexInGlobal = list.findIndex(function (x) {
                  return x.id === entry.id;
                });
                if (indexInGlobal !== -1) {
                  list.splice(indexInGlobal, 1);
                  saveDiary(list);
                  renderDiary();
                }
              });
              actions.appendChild(delBtn);
              card.appendChild(actions);

              diaryDayListEl.appendChild(card);
            });
          });
        }
      } else {
        // WEEK / MONTH
        dayNav.style.display = "none";
        diaryAddFormWrap.style.display = "none";
        diaryDayListEl.innerHTML = "";
        periodDaysEl.style.display = "block";

        var now = new Date();
        var daysBack = currentPeriod === "week" ? 6 : 29;
        var start = new Date(now);
        start.setDate(start.getDate() - daysBack);
        var startIso = formatDateISO(start);
        var grouped = groupDiaryByDate(diary);

        var dates = [];
        var cursor = new Date(start);
        while (cursor <= now) {
          dates.push(formatDateISO(cursor));
          cursor.setDate(cursor.getDate() + 1);
        }

        var allEntries = [];
        dates.forEach(function (d) {
          var entries = grouped[d] || [];
          allEntries = allEntries.concat(entries);
        });

        var totals = computeTotals(allEntries);
        if (allEntries.length) {
          diarySummaryEl.style.display = "block";
          var label =
            currentPeriod === "week"
              ? "–ò—Ç–æ–≥ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π"
              : "–ò—Ç–æ–≥ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π";
          summaryPeriodLabelEl.textContent = label;
          summaryKcalEl.textContent =
            round(totals.kcal) +
            " –∫–∫–∞–ª (‚âà " +
            round(totals.kcal / dates.length) +
            " –∫–∫–∞–ª/–¥–µ–Ω—å)";
          summaryMacrosEl.textContent =
            "–°—Ä–µ–¥–Ω–∏–µ –ë " +
            round(totals.p / dates.length) +
            " –≥ ‚Ä¢ –ñ " +
            round(totals.f / dates.length) +
            " –≥ ‚Ä¢ –£ " +
            round(totals.c / dates.length) +
            " –≥ –≤ –¥–µ–Ω—å";
        } else {
          diarySummaryEl.style.display = "none";
        }

        var container = document.createElement("div");
        container.className = "period-days-list";

        dates
          .slice()
          .reverse()
          .forEach(function (d) {
            var entries = grouped[d] || [];
            var dayTotals = computeTotals(entries);
            var row = document.createElement("div");
            row.className = "period-day-row";
            row.addEventListener("click", function () {
              currentPeriod = "day";
              currentDay = d;
              periodBtns.forEach(function (b) {
                b.classList.remove("active");
              });
              document
                .querySelector('.period-btn[data-period="day"]')
                .classList.add("active");
              renderDiary();
            });

            var dateEl = document.createElement("div");
            dateEl.className = "period-day-date";
            var dateObj = parseISODate(d);
            dateEl.textContent = formatDateNice(dateObj, todayIso) + " (" + d + ")";

            var kcalEl = document.createElement("div");
            kcalEl.className = "period-day-kcal";
            kcalEl.textContent = entries.length
              ? round(dayTotals.kcal) + " –∫–∫–∞–ª"
              : "–Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π";

            row.appendChild(dateEl);
            row.appendChild(kcalEl);
            container.appendChild(row);
          });

        periodDaysEl.innerHTML = "";
        periodDaysEl.appendChild(container);
      }
    }

    // ==== MEAL ADD FORM (select dish list) ====
    function updateMealDishSelect() {
      var select = mealDishEl;
      if (!select) return;
      var cards = loadDishCards();
      select.innerHTML = "";

      var optCustom = document.createElement("option");
      optCustom.value = "custom";
      optCustom.textContent = "–°–≤–æ–µ –±–ª—é–¥–æ (–≤–≤–µ—Å—Ç–∏ —Ä—É–∫–∞–º–∏)";
      select.appendChild(optCustom);

      cards.forEach(function (card) {
        var opt = document.createElement("option");
        opt.value = card.id;
        opt.textContent = card.name;
        select.appendChild(opt);
      });
    }

    btnAddMeal.addEventListener("click", function () {
      var portion = parseFloat(mealPortionEl.value || "0");
      if (!portion || portion <= 0) {
        alert("–£–∫–∞–∂–∏ –º–∞—Å—Å—É –ø–æ—Ä—Ü–∏–∏.");
        return;
      }

      var diary = loadDiary();
      var date = currentDay;
      var now = new Date();
      var timeVal = mealTimeEl.value;
      if (!timeVal) {
        var h = now.getHours().toString().padStart(2, "0");
        var m = now.getMinutes().toString().padStart(2, "0");
        timeVal = h + ":" + m;
      }

      var selectedId = mealDishEl.value;
      var name;
      var per100P = 0,
        per100F = 0,
        per100C = 0,
        per100K = 0;

      if (selectedId && selectedId !== "custom") {
        var cards = loadDishCards();
        var found = cards.find(function (c) {
          return c.id === selectedId;
        });
        if (!found) {
          alert("–ö–∞—Ä—Ç–æ—á–∫–∞ –±–ª—é–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.");
          return;
        }
        name = found.name;
        per100P = found.protein || 0;
        per100F = found.fat || 0;
        per100C = found.carbs || 0;
        per100K = found.kcal || 0;
      } else {
        name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞ –¥–ª—è –¥–Ω–µ–≤–Ω–∏–∫–∞:", "");
        if (!name) {
          alert("–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ.");
          return;
        }
        var p = parseFloat(prompt("–ë–µ–ª–∫–∏ –Ω–∞ 100 –≥ (–º–æ–∂–Ω–æ 0):", "0") || "0");
        var f = parseFloat(prompt("–ñ–∏—Ä—ã –Ω–∞ 100 –≥ (–º–æ–∂–Ω–æ 0):", "0") || "0");
        var c = parseFloat(prompt("–£–≥–ª–µ–≤–æ–¥—ã –Ω–∞ 100 –≥ (–º–æ–∂–Ω–æ 0):", "0") || "0");
        var k = parseFloat(prompt("–ö–∞–ª–æ—Ä–∏–∏ –Ω–∞ 100 –≥ (–º–æ–∂–Ω–æ 0):", "0") || "0");
        per100P = p || 0;
        per100F = f || 0;
        per100C = c || 0;
        per100K = k || (per100P * 4 + per100F * 9 + per100C * 4);
      }

      var mult = portion / 100;
      var portionP = per100P * mult;
      var portionF = per100F * mult;
      var portionC = per100C * mult;
      var portionK = per100K * mult;

      diary.push({
        id: uuid(),
        timestamp: new Date().toISOString(),
        date: date,
        time: timeVal,
        mealType: mealTypeEl.value,
        name: name,
        portionWeight: portion,
        per100Protein: per100P,
        per100Fat: per100F,
        per100Carbs: per100C,
        per100Kcal: per100K,
        portionProtein: portionP,
        portionFat: portionF,
        portionCarbs: portionC,
        portionKcal: portionK
      });

      saveDiary(diary);
      mealPortionEl.value = "";
      renderDiary();
    });

    // ==== INITIAL RENDER ====
    updateMealDishSelect();
    renderDishCards();
    renderDiary();
  </script>
</body>
</html>
